<head>
<script src="./index.js"></script>
<script>
	const ITEM_PER_PAGE = 5;
	var INDEX;

	var selectedPageElem = null;
	var selectedPageIdx = 0;

	function init(){
		const paginationElem = document.getElementById("Pagination");

		// Render Pagination
		const maxPageNum = Math.ceil(INDEX.length / ITEM_PER_PAGE);
		const pageBtnElemArr = [];
		for (let idx=0; idx<maxPageNum; idx++) {
			pageBtnElemArr.push(`<div class="pageBtn" onClick="gotoPage(${idx})">${idx}</div>`);
		}
		paginationElem.innerHTML = pageBtnElemArr.join('');

		gotoPage(0);
	}
	function gotoPage(pIdx) {
		const paginationElem = document.getElementById("Pagination");
		
		if (selectedPageElem) {
			selectedPageElem.classList.remove("active");
		}

		selectedPageElem = paginationElem.childNodes[pIdx];
		selectedPageElem.classList.add("active");
		selectedPageIdx = pIdx;
		renderReplayItems();
	}

	function renderReplayItems() {
		const mainPanelElem = document.getElementById("MainPanel");

		const start_idx = (selectedPageIdx * ITEM_PER_PAGE);
		const end_idx = ((selectedPageIdx + 1) * ITEM_PER_PAGE);
		const slice = [];
		for (let i=start_idx; i<end_idx && i<INDEX.length; i++) {
			slice.push({ oIdx: i, data: INDEX[i] });
		}

		// Render Replay-Items
		const itemArr = slice.map( (item) => {
				const imgUrl = (item.data.imgUrl)? item.data.imgUrl: "src/img/scroll-quill.svg";
				const extraInfo = item.data.info;
				const extraInfoArr = [];
				if (extraInfo != undefined) {
					Object.keys(extraInfo).forEach((key) => {
						extraInfoArr.push(`<label>${getInfoTitle(key)}</label>：${extraInfo[key]}`);
					});
				}

				return `<div class="ReplayBlock fadeIn"><div class="ReplayBlockOuter">
					<div class="image"><img src="${imgUrl}" /></div>
					<div class="info">
						<div class="header">
							<div class="title">${ item.data.title }</div>
							<div class="btn open" title="閱讀團錄" onClick="postToParentFrame(${ item.oIdx })"></div>
							<div class="btn popup" title="另開視窗" onClick="popup(${ item.oIdx })"></div>
						</div>
						<div class="extra-info">
							${ extraInfoArr.map(text => `<div class="into-item">${text}</div>`).join("") }
						</div>
					</div></div>
				</div>`;
			});

		mainPanelElem.innerHTML = itemArr.join('');
	}
	function getInfoTitle(key) {
		switch(key) {
			case "system": return "系統";
			case "gm": return "GM";
			case "member": return "玩家";
			case "startDate": return "起始時間";
		}
		return "???";
	}

	function clickPage(pIdx) {
		console.log(pIdx);
	}
	function postToParentFrame(index) {
		const data = { 'replay-index': index };
		window.parent.postMessage(data, "*");
	}
	function popup(index) {
		const replayInfo = INDEX[index];
		window.open(replayInfo.url + "/index.html", '_blank').focus();
	}

	window.onload = init;
</script>
<style>
	body {
		color: #fff;
		padding: 1em 2em;
	}
	h3 { color: #ddd; }
	hr {
		margin: 1rem 0;
		border-top: 3px double #8c8b8b;
	}
	a { color: plum }
	a:hover { color: rgb(250, 60, 60) }

	#MainPanel {
		display: flex; flex-direction: column;
		gap: 1rem;
	}
	.ReplayBlock {
		background-color: #00000050;
		width: 100%;
		max-width: 800px;
	}
	.ReplayBlockOuter { display: flex; gap: 10px; padding: 10px; }
	.ReplayBlock .image {
		background-color: #00000050;
		width: 100px; height: 100px; padding: 5px; border-radius: 5px;
	}
	.ReplayBlock .image img { width: 100%; height: 100%; border-radius: 5px; }
	.ReplayBlock .info { flex-grow: 1; }
	.ReplayBlock .info .header {
		display: flex; flex-direction: row; gap: 8px;
	}
	.ReplayBlock .info .header > .btn {
		cursor: pointer;
		width: 24px; height: 24px;
	}
	.ReplayBlock .info .header > .title {
		flex-grow: 1;
		font-weight: bold;
		font-size: 1.2em;
		margin-bottom: 10px;
		color: white;
	}
	.ReplayBlock .extra-info {
		display: flex; flex-direction: column;
		color: #d3d3d3;
	}
	
	.into-item { 
		background-color: #27292d;
		padding: 2px 5px; }
	.into-item:nth-of-type(odd) {
		background-color: #494a51;
	}

	.into-item > label {
		font-weight: bold;
	}

	#Pagination {
		display: flex; flex-direction: row; align-items: center; gap: 5px; flex-wrap: wrap;
		width: 100%; max-width: 800px; 
		margin-bottom: 1rem;
	}
	#Pagination > .pageBtn {
		cursor: pointer; background-color: #ffffff50; color: #fff;
		padding: 8px 16px; flex-shrink: 0;
	}
	#Pagination > .pageBtn:hover  { background-color: #ffffffa0; }
	#Pagination > .pageBtn:active,
	#Pagination > .pageBtn.active { background-color: black; }

	.fadeIn {
		opacity: 1;
		animation-name: fadeInOpacity;
		animation-iteration-count: 1;
		animation-timing-function: ease-in;
		animation-duration: .4s;
	}
	@keyframes fadeInOpacity {
		0% { opacity: 0; }
		100% { opacity: 1; }
	}

	.btn:hover { background-color: #00000050;}
	.btn.open  { content: url("src/img/open-book.svg"); }
	.btn.popup { content: url("src/img/expand-wide-svgrepo-com.svg"); }
</style>
</head>
<h3>歡迎來到我的團錄彙整站</h3>
<p>
	這裡是我存放過往文字團紀錄的倉庫。<br/>
	如果喜歡這個版型的話，歡迎到 <a href="https://github.com/hazmole/hazTRPG_log" target="_blank">Github</a> 將整個專案複製過去修改。
</p>

<hr/>

<div id="Pagination">
	<div class="pageBtn">1</div>
</div>
<div id="MainPanel">
</div>