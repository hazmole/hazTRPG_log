<head>
<title>CCFolia團錄重塑工具</title>
<style>
    .desc {
        color: #808080;
        margin: 0rem .5rem 1rem .5rem;
    }
    #btn {
        margin: 1rem; width: 120px; height: 40px;
    }
    #colorOptions {
        margin: 0.2rem;
        border: 1px solid #bfbfbf;
        padding: .5rem;
    }
    .fontColorBlock {
        display: inline-block;
        width: 40px;
        border: 1px solid black;
    }
</style>
<script>
var FILE_CONTENT = "";
var FILE_TITLE = "";

function handleFile(fileListObj){
    var checkResult = precheck(fileListObj);
    if(checkResult!=0) return ;

    FILE_TITLE = fileListObj[0].name;

    var fr=new FileReader();
    fr.onload=function(){
        FILE_CONTENT = fr.result;
        document.getElementById("fileName").value = FILE_TITLE;

        document.getElementById("btn").disabled = false;
        document.getElementById("fileName").disabled = false;

        var obj = document.getElementById("fileMode");
        if(isCCF()) obj.value = "ccf";
        if(isDDF()) obj.value = "ddf";

        document.getElementById("nightmode").disabled = (obj.value=="ddf")? true: false;
        document.getElementById("nightmode").checked = (obj.value=="ddf")? false: true;
        document.getElementById("idOnly").disabled = (obj.value=="ddf")? true: false;
    }
    fr.readAsText(fileListObj[0]);
}
function download(){
    var fileName = document.getElementById("fileName").value;
    var config = {
        title: document.getElementById("fileTitle").value,
        subtitle: document.getElementById("fileSubtitle").value,
        mode: document.getElementById("fileMode").value,
        isNightmode: document.getElementById("nightmode").checked,
        isIdOnly: document.getElementById("idOnly").checked,
    };

    if((config.mode=="ccf" && !isCCF()) || (config.mode=="ddf" && !isDDF())){
        alert(`file doesn't match ${config.mode} format!`);
        return ;
    }

    var element = document.createElement('a');
    element.setAttribute('href','data:text/plain;charset=utf-8,' + 
        encodeURIComponent(formatHTML(FILE_CONTENT, config)));
    element.setAttribute('download', fileName);
    document.body.appendChild(element);
    element.click();
}


function formatHTML(content, config){
    // parse Config
    var title = config.title;
    var subtitle = config.subtitle;
    var mode = config.mode;
    var isNightmode = config.isNightmode;
    var isIdOnly = config.isIdOnly;

    // Append Style
    var styleList = getInjectStyle(mode, config);
    content = content.replace('</head>', `<style>${styleList.join("")}</style>\n</head>`);

    // Handle Title
    if(subtitle || title){
        content = content.replace('<body>', `<body>\n<hr>`);
        content = content.replace(/<title>.*<\/title>/, `<title>${title} - ${subtitle}</title>`);      
    }
    if(subtitle){
        content = content.replace('<body>', `<body>\n<div class="subtitle">${subtitle}</div>`);
    }
    if(title){
        content = content.replace('<body>', `<body>\n<div class="title">${title}</div>`);
    }

    // Handle DodontoF Extra
    if(mode=="ddf"){
        content = content.replace(/<\/b>：/g, '：</b>');
    }

    // Replace Color
    var colorList = getAllPlayerColor(config.mode);
    if(isNightmode){
        Object.keys(colorList).map(color=>{
            var reg = new RegExp(`color:${color};`, 'g');
            if(color=="#888888"){
                content = content.replace(reg, `color:#dcddde;`);
            }
            else if(color=="#000000"){
                content = content.replace(reg, `color:#dcddde;`);
            }
            else{
                var newColor = getBrighterColor(color);
                if(newColor!=color){
                    content = content.replace(reg, `color:${newColor};`);
                }
            }
        });
    }

    // Save
    return content;
}
function getInjectStyle(mode, config){
    var mode = config.mode;
    var isNightmode = config.isNightmode;
    var isIdOnly = config.isIdOnly;

    var defaultTextColor = isNightmode? "#dcddde": "#000000";
    var defaultSubTextColor = isNightmode? "#bfbfbf": "#808080";

    var styleList = [];
    styleList.push("body {font-family:'Whitney','Helvetica Neue','Helvetica','Arial','sans-serif';padding: 0 1rem;}");
    styleList.push(`.title {color:${defaultTextColor};font-size:2rem;font-weight:bold;}`);
    styleList.push(`.subtitle {color:${defaultSubTextColor};font-size:1.1rem;font-weight:bold;}`);

    if(isNightmode){
        styleList.push("body {background:#31363c;}");
    }
    if(isIdOnly && mode=="ccf"){
        styleList.push(`span:nth-child(3) {color:${defaultTextColor};}`);
    }

    switch(mode){
        case "ccf": // ccfolia
            styleList.push("p {border-bottom:#5d5d5d solid thin;}");
            styleList.push("span:nth-child(2) {font-weight:bold;}");
            styleList.push("span:nth-child(3) {display:block;margin-left:1em;margin-bottom:.5em;}");
            break;
        case "ddf": // dodontoF
            styleList.push("font {display:block;border-bottom:#c3c3c3 solid thin;padding-left:1em;padding-bottom:.5em;}");
            styleList.push("font b {display:block;margin-left:-1em;}");
            break;
    }

    return styleList;
}


//==============
function isCCF(){
    var matchResult = FILE_CONTENT.match(/style="color:#[\w\d]+;"/);
    return (matchResult!=null);
}
function isDDF(){
    var matchResult = FILE_CONTENT.match(/color='#[\w\d]+'/);
    return (matchResult!=null);
}

//==============
// Color Options
function getAllPlayerColor(mode){
    var colorList = {};
    var matchArr = [];
    if(mode=="ccf")      matchArr = FILE_CONTENT.match(/style="color:#[\w\d]+;"/g);
    else if(mode=="ddf") matchArr = FILE_CONTENT.match(/color='#[\w\d]+'/g);
    matchArr.map(style => {
        var color = style.match(/(#[\w\d]+)/)[0];
        colorList[color] = false;
    });
    return colorList;
}
function getBrighterColor(colorCode){
    var matchResult = colorCode.match(/#([\w\d]{2})([\w\d]{2})([\w\d]{2})/);
    var rgbArr = [];
    rgbArr.push(parseInt(matchResult[1],16));
    rgbArr.push(parseInt(matchResult[2],16));
    rgbArr.push(parseInt(matchResult[3],16));
    
    var totalVal = rgbArr.reduce((a,b)=>a+b);

    var rgbArrNew = null
    if(totalVal/3<150){
        console.log()
        rgbArrNew = rgbArr.map(colorVal => {
            var newVal = Math.floor(colorVal*1.3);
            return newVal>255? 255: newVal;
        });
    }
    else
        return colorCode;

    var newColorCode = "#"+rgbArrNew.map(val=>getColorCode(val)).join("");
    return newColorCode;

    //================
    function getColorCode(val){
        var hex = val.toString(16);
        return hex.length==1? ("0"+hex): hex;
    }
}


function precheck(fileListObj){
    if(fileListObj.length!=1) return 1;
    if(fileListObj[0].name.match(/\.html$/)==null) return 2;

    return 0;
}

</script>
</head>
<body>
<center>
    <b style="font-size: 2rem;">CCFolia團錄重塑工具</b> version 1.2
    <div class="desc" style="margin-bottom: 1.5rem;">讓你的ccfolia文字團錄弄的好看一點！</div>
    <img src="001.png"/>
</center>
<hr/>

    <b>團錄檔案</b>：<input type="file" id="fileInput" onchange="handleFile(this.files)" />
    <div class="desc">選擇你的團錄輸出檔(.html)。（支援ccfolia和dodontoF）</div>
    
    <div><b>團錄來源</b>：
        <select id="fileMode" disabled="true">
            <option value="ccf" selected>ccfolia/ココフォリア</option>
            <option value="ddf">dodontoF/どどんとふ</option>
        </select>
    </div>

<hr/>
<b>新團錄設定</b>
    <div><b>檔名　</b>：<input type="text" id="fileName" disabled="true" style="width:400px"></div>
    <div><b>標題　</b>：<input type="text" id="fileTitle" placeholder="團的標題（團名）" style="width:400px"></div>
    <div><b>副標題</b>：<input type="text" id="fileSubtitle" placeholder="副標題或者跑團時間" style="width:400px"></div>
    <div><b>夜晚模式</b>：<label><input id="nightmode" type="checkbox" checked="true">啟用</label></div>
    <div><b>只有ID字色</b>：<label><input id="idOnly" type="checkbox">啟用</label></div>

    <input type="button" id="btn" value="下載檔案" disabled="true" onclick="download()" />

<hr/>
<div style="color:#ba006a">
有任何疑問或改進建議，煩請聯絡我們．<br/>
<ul>
    <li>Github專案: <a href="https://github.com/hazmole/hazTRPG_log">https://github.com/hazmole/hazTRPG_log</a></li>
</ul>
</div>
</body>